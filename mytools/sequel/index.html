<!DOCTYPE html>
<html lang="en">

<head>

	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="description" content="Sequel Movies Meter, Check how people reacted to sequel movies">
	<meta name="author" content="@housamz">
	<link rel="icon" href="static/favicon.ico">

	<title>Sequel Movies Meter :: Charts</title>

	<!-- Bootstrap core CSS -->
	<link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

	<link href="static/style.css" rel="stylesheet">
</head>

<body>

	<nav class="navbar navbar-expand-md fixed-top bg-light">
		<div class="container">
			<span class="navbar-brand">
				Sequel Movies Meter<br>
				<small>Check how people reacted to sequel movies</small>
			</span>
			<div class="collapse navbar-collapse" id="navbarCollapse">
				<ul class="navbar-nav mr-auto">
					<li class="nav-item active">
						<a class="nav-link" href="./">Charts</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="./all.html">Movies</a>
					</li>
				</ul>
				
			</div>
			<div id="legend" class="float-right">
					<ul>
						<li>Legend: </li>
						<li>⦿ Critics</li>
						<li>⦿ Users</li>
					</ul>
				</div>
		</div>
	</nav>

	<!-- Page Content -->
	<div class="container">

		<div class="row" id="movies-div">
			<!-- This div gets filled by D3JS -->
		</div>
		<!-- /.row -->

		<div id="preloader">
			<div class="dot1"></div>
			<div class="dot2"></div>
		</div>

	</div>
	<!-- /.container -->

	<!-- Footer -->
	<footer class="py-5">
		<div class="container">
			<p class="m-0 text-center">Copyright © <a href="http://hmz.ie">Sequel Movie Meter</a> 2018<script>new Date().getFullYear()>2018&&document.write("-"+new Date().getFullYear());</script>, a project by <a href="http://hmz.ie">@housamz</a></p>
		</div>
		<!-- /.container -->
	</footer>

	<a href="javascript:" id="return-to-top">Back to top</a>

	<!-- Bootstrap core JavaScript -->
	<script src="vendor/jquery/jquery.min.js"></script>
	<script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
	<script src="vendor/d3js/d3.v4.min.js"></script>
	<script src="static/script.js"></script>

	<script type="text/javascript">
		function isAvailable(v, normalise){
			if(v > 0 && v <= 100){
				if (normalise){
					return v*10;
				} else {
					return v;
				}
			} else {
				return false;
			}
		}

		function wrap(text, width) {
			text.each(function() {
				var text = d3.select(this),
					words = text.text().split(/\s+/).reverse(),
					word,
					line = [],
					lineNumber = 0,
					lineHeight = 1.1, // ems
					y = text.attr("y"),
					dy = parseFloat(text.attr("dy")),
					tspan = text.text(null).append("tspan").attr("x", 0).attr("y", y).attr("dy", dy + "em");
				while (word = words.pop()) {
					line.push(word);
					tspan.text(line.join(" "));
					if (tspan.node().getComputedTextLength() > width) {
						line.pop();
						tspan.text(line.join(" "));
						line = [word];
						tspan = text.append("tspan").attr("x", 0).attr("y", y).attr("dy", `${++lineNumber * lineHeight + dy}em`).text(word);
					}
				}
			})
		}

		// Implementing tooltip, but it might be noisy on the graph
		var div = d3.select("body").append("div")
			.attr("class", "tooltip")
			.style("opacity", 0);

		d3.json("static/single-score.json", function(error, data){

			if (error) {
				console.log(error);
			} else {
				for (var i = 0; i < data.length; i++) {
					var title = Object.keys(data[i])[0];
					var chartData = data[i][title];
					addChart(chartData, title);

					if (i === data.length - 1){
						finishedloading = true;
					}
				}
			}
		});

		function addChart(data, title){

			var divSize = 4;
				
			// if the movies in one sequel are more than four, change the div width
			if(data.length > 4 && data.length <= 8){
				divSize = 8;
			} else if(data.length > 8){
				divSize = 12;
			}

			var movie_div = d3.select("#movies-div")
				.append("div").attr("class", "col-sm-12 col-md-" + divSize + " movie-item")
				.append("div").attr("class", "card h-100")
				.append("div").attr("class", "card-body");
				
			var titles = movie_div.append("h5").attr("class", "card-title");
			titles.html(title+' <small class="float-right">'+data.length+' movies</small>');

			// set the dimensions and margins of the graph
			var divWidth = parseInt(movie_div.style("width"));
			var margin = {top: 10, right: 40, bottom: 10, left: 30},
				width = divWidth - margin.left - margin.right,
				height = 300 - margin.top - margin.bottom,
				xAxisStart = height-100;

			// set the ranges
			var x = d3.scalePoint().range([0, width]).padding(.2);
			var y = d3.scaleLinear().range([xAxisStart, 0]);

			var xAxis = d3.axisBottom()
						.scale(x)
						.tickFormat(function(d, i) { return data[i].name+' ('+data[i].year+')'; });

			var yAxis = d3.axisLeft()
						.scale(y);

			y.domain([0,100]);
			x.domain(data.map( function (d) { return d.name;}));

			// define the lines
			var critics_line = d3.line()
				.defined(function(d){return d.critics != "N/A" && d.critics != undefined})
				.x(function (d) {
					return x(d.name);
				})
				.y(function(d) {
					var n = isAvailable(d.critics);
					return y(n);
				});

			var users_line = d3.line()
				.defined(function(d){return d.users != "N/A" && d.users != undefined})
				.x(function (d) {
					return x(d.name);
				})
				.y(function(d) {
					var n = isAvailable(d.users);
					return y(n)
				});

			var charts = movie_div.append("div").attr("class", "chart").append("svg")
				.attr("width", width + margin.left + margin.right)
				.attr("height", height + margin.top + margin.bottom)
				.append("g")
				.attr("transform",
					"translate(" + margin.left + "," + margin.top + ")");

			charts.append("g")
				.attr("class", "grid")
				.call(d3.axisLeft(y)
					.tickSize(-width)
					.tickFormat("")
					.ticks(10)
				);


			// build the critics line and dots
			var critics = charts.append("g")
				.attr("class", "critics");

			critics.append("path")
					.attr("class", "critics-line")
					.attr("d", critics_line(data));

			critics.selectAll("critics-circle")
				.data(data.filter(function(d) { return d.critics != "N/A"; }))
				.enter().append("circle")
				.attr("r", 3)
				.attr("cx", critics_line.x())
				.attr("cy", critics_line.y());

			// build the users line and dots
			var users = charts.append("g")
				.attr("class", "users");

			users.append("path")
				.attr("class", "users-line")
				.attr("d", users_line(data));

			users.selectAll("users-circle")
				.data(data.filter(function(d) { return d.users != "N/A"; }))
				.enter().append("circle")
				.attr("r", 3)
				.attr("cx", users_line.x())
				.attr("cy", users_line.y());

			// Add the X Axis
			charts.append("g")
				.attr("class", "x axis")
				.attr("transform", "translate(0," + xAxisStart + ")")
				.call(xAxis)
				.selectAll(".tick text")
					.style("text-anchor", "end")
					.attr("dx", "-.8em")
					.attr("dy", ".15em")
					.attr("transform", "rotate(-65)")
					.call(wrap, 100);

			// Add the Y Axis
			charts.append("g")
				.attr("class", "y axis")
				.call(yAxis);
		}
	</script>

	<!-- Google Analytics -->
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-1386199-11', 'auto');
		ga('send', 'pageview', {
			'page': '/',
			'title': ''
		});
	</script>
	<!-- End Google Analytics -->

</body>

</html>
